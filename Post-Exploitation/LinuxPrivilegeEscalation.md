
# Linux Privilege Escalation

> **Note:** Only practice these techniques on systems you are explicitly authorized to test (labs, VMs, RoE). The examples below show common, real-world vectors: weak permissions, writable system files, and misconfigured `sudo`.

---

## 1. Weak permissions — quick intro
**Weak permissions** means files or directories are readable/writable/executable by users who shouldn't have that power. Attackers (or a low-priv user) can abuse these misconfigurations to escalate to **root**.

**Context / lab:**  
You already have a shell on the target as an unprivileged user:

```text
whoami
cat /etc/passwd
groups student
````

Your goal is to identify writable files and privileged misconfigurations.

---

### Find world-writable files

```bash
find / -not -type l -perm -o+w 2>/dev/null
```

**What the command means (term-by-term):**

* `find /` — search from root (entire filesystem).
* `-not -type l` — **exclude** symbolic links (avoid following / printing symlinks).
* `-perm -o+w` — show files where the *other* (everyone) permission includes `write`.

  * `-o` = "others" (not owner or group)
  * `+w` / `-w` notation: here `-perm -o+w` finds files writable by others.
* `2>/dev/null` — hide permission-denied errors for cleanliness.

**Alternatives / variants:**

* `find / -perm /o=w` — POSIX style: any file where *others* have write.
* `find / -writable -type f` — finds files writable by the current user (useful to find what *you* can write).
* `find / -perm -u=s -o -perm -g=s` — find suid/sgid binaries.

---

### Why this matters

If a *sensitive* file (owned by root) is world-writable, you may be able to **modify it** and cause escalation. Typical targets: scripts run by root, configuration files loaded by privileged services, or backup files containing secrets.

---

## 2. Example: `/etc/shadow` discovered writable

You find `/etc/shadow` in the search results. What is it and why is it important?

### What is `/etc/shadow`?

* `/etc/shadow` stores **local user account password hashes** (not plaintext).
* Only root should be able to read or write this file — it contains hashed passwords used by `passwd`/`login`/`sshd` for authentication.

**If `/etc/shadow` is writable by you:**
You could replace a user’s hash with a hash for a password you know, then `su` to that user (or root) using the corresponding plaintext password — **immediate privilege escalation** if you replace the root hash.

---

### How password hashes work (short)

* Passwords are hashed (not stored plain). Linux typically uses salted hashes (e.g., `$1$` = MD5, `$6$` = SHA-512).
* You need to produce a correct hashed string matching the format used on the target, then put that in `/etc/shadow`.

---

### Creating a password hash with `openssl`

Example: generate an MD5 (crypt) hash with salt `abc` for password `p@ssw0rd`:

```bash
openssl passwd -1 -salt abc 'p@ssw0rd'
# example output: $1$abc$K1fQm... (this is the hash)
```

**What the flags mean:**

* `passwd` (OpenSSL) — generates password hashes compatible with /etc/shadow formats.
* `-1` — use MD5-based crypt (older); replace with `-6` for SHA-512 on systems using `$6$` hashes.
* `-salt abc` — provide salt (must match the expected format; any salt works logically but attacker chooses one).
* `'p@ssw0rd'` — the plaintext password you will later use to `su`.

**Important:** Match the hash scheme used on the target (check an existing /etc/shadow line to see prefix like `$6$`).

---

### Replace the hash & escalate (hypothetical flow)

1. Backup original (if allowed / for cleanup):

   ```bash
   cp /etc/shadow /tmp/shadow.bak
   ```
2. Edit `/etc/shadow` as root-writable (in the lab you found it writable):

   * For root user line: replace the hash field with the hash you generated.
3. Switch user:

   ```bash
   su - root
   # enter the plaintext password you used for the hash
   ```
4. If successful → **root shell**.

> **Why this is risky / uncommon:** Modern systems rarely have `/etc/shadow` world-writable. If you find it, it’s a severe misconfiguration.

---

## 3. Exploiting `sudo` misconfigurations

### Check what you can run with `sudo`

```bash
sudo -l
```

This lists commands you are allowed to run via `sudo`, sometimes with `NOPASSWD` (no password required).

**Example found in lab:**

```
(root) NOPASSWD: /usr/bin/man
```

This means the unprivileged user can run `/usr/bin/man` as root **without a password**.

---

### Why `man` is dangerous when run as root

* `man` opens manual pages and often spawns a pager (like `less`) that supports `!` to run shell commands or spawns editors.
* Historically, you can escape to a shell from `man` / `less` using `!` or `v` (to open in `vi`), or with a pager escape sequence.

**Exploit example:**

```bash
sudo man man        # run man as root
# inside man: press '!' or 'v' or type '!/bin/bash' depending on pager
!/bin/bash
# you get a root shell
```

**Why this works:** `sudo` executes the `man` binary as root. `man` or its pager runs a child shell under that root context, giving you a root shell.

---

### Common binaries abused like this

* `man`, `less`, `more`, `vi`, `vim`, `awk`, `find` (with -exec), `nmap` (interactive mode), `python`/`perl` when allowed via sudo, or any utility that can invoke a shell or write files as root.

---

## 4. Defenses & mitigation (short)

* Ensure critical files (`/etc/shadow`, `/etc/passwd`, service configs) are **not writable** by unprivileged users. Use correct permissions (`chmod 600 /etc/shadow`).
* Harden `sudoers`: avoid `NOPASSWD` for broad binaries; prefer fine-grained `sudo` rules.
* Use least privilege for service accounts and avoid world-writeable directories on `PATH`.
* Monitor and alert on changes to critical files (file integrity monitoring).
* Regularly run linters/automated checks (LinEnum, Lynis, CIS scripts) to detect misconfigs.

---

## 5. Tools & references

* **LinEnum** — quick local enumeration script that finds SUID binaries, writable files, unusual configs and more.
  GitHub: `https://github.com/rebootuser/LinEnum`
* `find`, `awk`, `sed`, `stat`, `ls -l` — basic UNIX tools for permissions analysis.
* `openssl passwd` or `mkpasswd` (from `whois` package) — for generating password hashes matching `/etc/shadow` formats.

---

## 6. Final practical notes

* Always **backup** original files before making changes (if allowed) and **log** everything.
* Test any exploit or modification in an isolated VM with the same distro/version first.
* If you can edit `/etc/shadow` as a non-root user, treat it as **game over** — it's one of the highest-severity misconfigurations.


```bash
# find world-writable files (excluding symlinks)
find / -not -type l -perm -o+w 2>/dev/null

# check /etc/shadow permissions
ls -l /etc/shadow
# generate a SHA-512 hash (if system uses $6$)
openssl passwd -6 -salt mysalt 'MyP@ssw0rd'
# run LinEnum (after upload)
chmod +x LinEnum.sh
./LinEnum.sh
# check sudo rights
sudo -l
```
